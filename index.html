<!DOCTYPE html>
<html>
  <head>
    <title>Gu√≠a Virtual - La Floresta</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Font Awesome para iconos bonitos -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100vh;
        width: 100%;
      }

      /* Estilos para iconos personalizados */
      .custom-div-icon {
        background: transparent;
        border: none;
      }

      .poi-icon {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        color: white;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        border: 2px solid white;
      }

      /* Iconos por categor√≠a */
      .icon-plaza {
        background: linear-gradient(135deg, #2ecc71, #27ae60);
      }

      .icon-club {
        background: linear-gradient(135deg, #3498db, #2980b9);
      }

      .icon-hotel {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
      }

      .icon-default {
        background: linear-gradient(135deg, #9b59b6, #8e44ad);
      }
      
      /* Estilos para el panel de testing */
      #testing-panel {
        position: fixed;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px;
        border-radius: 8px;
        font-family: Arial, sans-serif;
        font-size: 12px;
        z-index: 1000;
        max-width: 250px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      }
      
      #testing-panel h3 {
        margin: 0 0 10px 0;
        color: #ffd700;
        font-size: 14px;
      }
      
      #testing-panel.hidden {
        display: none;
      }
      
      .testing-instructions {
        line-height: 1.4;
        margin: 5px 0;
      }
      
      .testing-status {
        color: #4CAF50;
        font-weight: bold;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    
    <!-- Panel de instrucciones para testing -->
    <div id="testing-panel">
      <h3>üéÆ Modo Testing</h3>
      <div class="testing-instructions">
        <strong>Presiona 'T'</strong> para activar testing
      </div>
      <div class="testing-instructions">
        Luego usa las flechas:<br>
        ‚¨ÜÔ∏è ‚¨áÔ∏è ‚¨ÖÔ∏è ‚û°Ô∏è (‚âà5m cada clic)
      </div>
      <div class="testing-instructions">
        <small>üîä Audio: MP3 o voz sint√©tica</small>
      </div>
      <div id="testing-status" class="testing-status" style="display: none;">
        ‚úÖ Modo Testing Activo
      </div>
    </div>

    <script>
      // --- FASE 1: TUS DATOS (PUNTOS DE INTER√âS) ---
      // Aqu√≠ es donde pones tus coordenadas y rese√±as.
      // He usado el formato GeoJSON que te recomend√©.
      const misPuntos = {
        type: "FeatureCollection",
        features: [
          {
            type: "Feature",
            geometry: {
              type: "Point",
              // ¬°IMPORTANTE! Reemplaza esto con tus coordenadas
              coordinates: [-55.677874536889675, -34.76094347598904],
            },
            properties: {
              id: "poi_1",
              nombre: "Hotel La Floresta",
              descripcion:
                "El ic√≥nico Ex-Hotel La Floresta es el s√≠mbolo del balneario...",
              audio: "audio/hotel.mp3",
              orden: 1,
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              // ¬°IMPORTANTE! Reemplaza esto con tus coordenadas
              coordinates: [-55.67480651313868, -34.75741890973529], // [Longitud, Latitud]
            },
            properties: {
              id: "poi_2",
              nombre: "Country Club",
              descripcion:
                "El Country Club es el coraz√≥n recreativo y deportivo de La Floresta. Esta zona ...",
              audio: "audio/country.mp3",
              orden: 2,
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              // ¬°IMPORTANTE! Reemplaza esto con tus coordenadas
              coordinates: [-55.67574992051011, -34.75374934645494], // [Longitud, Latitud]
            },
            properties: {
              id: "poi_3",
              nombre: "Plaza 33",
              descripcion:
                "La Plaza 33 es un espacio p√∫blico que fomenta la convivencia y el esparcimiento.",
              audio: "audio/plaza33.mp3",
              orden: 3,
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              // ¬°IMPORTANTE! Reemplaza esto con tus coordenadas
              coordinates: [-55.668644494635636, -34.75719219349257], // [Longitud, Latitud]
            },
            properties: {
              id: "poi_4",
              nombre: "Plaza Salvador Garc√≠a Pintos",
              descripcion:
                " Inaugurada en 2021, esta plaza es un ejemplo de transformaci√≥n. Lo que antiguamente era un basural, hoy es un espacio p√∫blico renovado y lleno de vida. ",
              audio: "audio/plazaSalvador.mp3",
              orden: 4,
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              // ¬°IMPORTANTE! Reemplaza esto con tus coordenadas
              coordinates: [-55.667910491734084, -34.75958472020964], // [Longitud, Latitud]
            },
            properties: {
              id: "poi_5",
              nombre: "Plazoleta del Leonismo",
              descripcion:
                "Esta plazoleta es un homenaje a los valores del Club de Leones (Leonismo) y su servicio ...",
              audio: "audio/plazaleonismo.mp3",
              orden: 5,
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              // ¬°IMPORTANTE! Reemplaza esto con tus coordenadas
              coordinates: [-55.673522605168316, -34.7595672510129], // [Longitud, Latitud]
            },
            properties: {
              id: "poi_6",
              nombre: "Plaza Artigas",
              descripcion:
                "Como en la mayor√≠a de las localidades uruguayas, esta plaza rinde homenaje al Pr√≥cer de la P√°tria ...",
              audio: "audio/plazaartigas.mp3",
              orden: 6,
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              // ¬°IMPORTANTE! Reemplaza esto con tus coordenadas
              coordinates: [-55.67520041687363, -34.75938912256196], // [Longitud, Latitud]
            },
            properties: {
              id: "poi_7",
              nombre: "Plaza Don Orione",
              descripcion:
                "Esta plaza toma su nombre en honor a San Luis Orione, fundador del Movimiento Orionita...",
              audio: "audio/plazaorione.mp3",
              orden: 7,
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              // ¬°IMPORTANTE! Reemplaza esto con tus coordenadas
              coordinates: [-55.67574879662696, -34.76037254637836], // [Longitud, Latitud]
            },
            properties: {
              id: "poi_8",
              nombre: "Plaza Zorrilla de San Mart√≠n",
              descripcion:
                "Dedicada al 'Poeta de la Patria', Juan Zorrilla de San Mart√≠n. Este espacio rinde tributo a su monumental obra literaria",
              audio: "audio/plazazorrilla.mp3",
              orden: 8,
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              // ¬°IMPORTANTE! Reemplaza esto con tus coordenadas
              coordinates: [-55.67690120312782, -34.76062577419499], // [Longitud, Latitud]
            },
            properties: {
              id: "poi_9",
              nombre: "Plaza Liga de Fomento",
              descripcion:
                "Este espacio celebra el esp√≠ritu c√≠vico de la Liga de Fomento de La Floresta.",
              audio: "audio/plazaligafomento.mp3",
              orden: 9,
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              // ¬°IMPORTANTE! Reemplaza esto con tus coordenadas
              coordinates: [-55.680042668032684, -34.75882526846987], // [Longitud, Latitud]
            },
            properties: {
              id: "poi_10",
              nombre: "Plaza Lavalleja",
              descripcion:
                "Esta plaza honra la memoria de Juan Antonio Lavalleja, l√≠der de los Treinta y Tres Orientales. Es un espacio que ...",
              audio: "audio/plazalavalleja.mp3",
              orden: 10,
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              // ¬°IMPORTANTE! Reemplaza esto con tus coordenadas
              coordinates: [-55.68000110452356, -34.752043461814516], // [Longitud, Latitud]
            },
            properties: {
              id: "poi_11",
              nombre: "Plaza Zabala",
              descripcion:
                "Un rinc√≥n que recuerda al fundador de Montevideo, Bruno Mauricio de Zabala. Esta plaza conecta al ...",
              audio: "audio/plazazabala.mp3",
              orden: 11,
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              // ¬°IMPORTANTE! Reemplaza esto con tus coordenadas
              coordinates: [-55.676521832650906, -34.75779537345324], // [Longitud, Latitud]
            },
            properties: {
              id: "poi_12",
              nombre: "Plaza Rivera",
              descripcion:
                "Dedicada a Fructuoso Rivera, primer presidente constitucional de Uruguay y figura clave en los primeros a√±os de la Rep√∫blica.",
              audio: "audio/plazarivera.mp3",
              orden: 12,
            },
          },

          // ... Agrega aqu√≠ tus otros 10 puntos ...
        ],
      };

      // --- FASE 2: EL MAPA (LEAFLET) ---

      // 1. Inicializar el mapa
      // Centramos el mapa en La Floresta (ajusta estas coordenadas si es necesario)
      const map = L.map("map").setView([-34.757, -55.665], 16);

      // 2. Cargar el mapa base (OpenStreetMap)
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "¬© OpenStreetMap",
      }).addTo(map);

      // Funci√≥n para determinar el icono basado en el nombre del punto
      function obtenerIconoPorNombre(nombre) {
        const nombreLower = nombre.toLowerCase();

        if (nombreLower.startsWith("pla")) {
          return {
            className: "icon-plaza",
            iconClass: "fas fa-tree", // Icono de √°rbol para plazas
            title: "Plaza",
          };
        } else if (
          nombreLower.startsWith("clu") ||
          nombreLower.includes("club") ||
          nombreLower.includes("country")
        ) {
          return {
            className: "icon-club",
            iconClass: "fas fa-users", // Icono de personas para clubes
            title: "Club/Instituci√≥n Recreativa",
          };
        } else if (nombreLower.includes("hotel")) {
          return {
            className: "icon-hotel",
            iconClass: "fas fa-bed", // Icono de cama para hoteles
            title: "Hotel",
          };
        } else {
          return {
            className: "icon-default",
            iconClass: "fas fa-map-marker-alt", // Icono gen√©rico
            title: "Punto de Inter√©s",
          };
        }
      }

      // Funci√≥n para crear icono personalizado
      function crearIconoPersonalizado(nombre) {
        const tipoIcon = obtenerIconoPorNombre(nombre);

        return L.divIcon({
          className: "custom-div-icon",
          html: `<div class="poi-icon ${tipoIcon.className}" title="${tipoIcon.title}">
                   <i class="${tipoIcon.iconClass}"></i>
                 </div>`,
          iconSize: [30, 30],
          iconAnchor: [15, 15],
          popupAnchor: [0, -15],
        });
      }

      // Un objeto para guardar nuestros marcadores y poder llamarlos
      let marcadoresLeaflet = {};

      // 3. Agregar tus puntos (POIs) al mapa
      L.geoJSON(misPuntos, {
        pointToLayer: function (feature, latlng) {
          // Crear marcador con icono personalizado basado en el nombre
          const iconoPersonalizado = crearIconoPersonalizado(
            feature.properties.nombre
          );
          return L.marker(latlng, { icon: iconoPersonalizado });
        },
        onEachFeature: function (feature, layer) {
          // Esto crea el popup usando la informaci√≥n de tus datos
          const popupContent = `<b>${feature.properties.nombre}</b><br>${feature.properties.descripcion}`;
          layer.bindPopup(popupContent);
          // Guardamos el marcador (layer) usando su ID como llave
          marcadoresLeaflet[feature.properties.id] = layer;
        },
      }).addTo(map);

      // --- FUNCI√ìN NUEVA: DIBUJAR RUTA ---

        function dibujarRutaCompleta() {
            // 1. Ordenar los puntos seg√∫n la propiedad "orden"
            const puntosOrdenados = misPuntos.features.sort((a, b) => {
                return a.properties.orden - b.properties.orden;
            });

            // 2. Extraer solo las coordenadas [lat, lon]
            const coordenadasRuta = puntosOrdenados.map(feature => {
                // De nuevo, [lon, lat] -> [lat, lon] para Leaflet
                return [feature.geometry.coordinates[1], feature.geometry.coordinates[0]];
            });

            // 3. Dibujar la l√≠nea (Polyline)
            L.polyline(coordenadasRuta, {
                color: '#3388ff', // Color azul
                weight: 3,
                opacity: 0.7,
                dashArray: '5, 10' // L√≠nea punteada
            }).addTo(map);
        }

        // ¬°Y llamamos a la funci√≥n para que se ejecute!
        dibujarRutaCompleta();

        // --- FUNCI√ìN NUEVA: SINTETIZADOR DE VOZ ---
        function hablarTexto(texto) {
            console.log(`Hablando: ${texto}`);
            try {
                // Detener cualquier voz que est√© sonando antes
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(texto);
                utterance.lang = 'es-UY'; // Espa√±ol de Uruguay
                window.speechSynthesis.speak(utterance);
                
            } catch (e) {
                console.error("Error al sintetizar la voz: ", e);
            }
        }

      // --- FASE 3: GEOLOCALIZACI√ìN EN TIEMPO REAL ---

      let marcadorUsuario = null; // Variable para guardar nuestro marcador
      let posicionActualUsuario = null; // <-- ¬°NUEVA L√çNEA!

      // 1. Opciones para la geolocalizaci√≥n
      const opcionesGeo = {
        enableHighAccuracy: true, // Pedir la m√°xima precisi√≥n posible
        timeout: 10000, // Tiempo m√°ximo de espera (10 seg)
        maximumAge: 0, // No usar una ubicaci√≥n "cacheada"
      };

      // 2. Comprobar si el navegador soporta Geolocation
      if ("geolocation" in navigator) {
        console.log("Geolocalizaci√≥n soportada. Iniciando...");

        // 3. Iniciar el "seguimiento" de la posici√≥n
        // 'watchPosition' se ejecuta CADA VEZ que el usuario se mueve
        navigator.geolocation.watchPosition(
          onUbicacionCorrecta,
          onUbicacionError,
          opcionesGeo
        ); 
      } else {
        alert(
          "Tu navegador no soporta Geolocalizaci√≥n. Esta aplicaci√≥n no funcionar√°."
        );
      }

      // 4. Funci√≥n que se ejecuta cuando OBTENEMOS la ubicaci√≥n
      function onUbicacionCorrecta(e) {
        const lat = e.coords.latitude;
        const lon = e.coords.longitude;

        posicionActualUsuario = L.latLng(lat, lon); // <-- ¬°NUEVA L√çNEA!

        const precision = e.coords.accuracy;

        console.log(
          `Nueva ubicaci√≥n: ${lat}, ${lon} (Precisi√≥n: ${precision}m)`
        );

        // Centrar el mapa en el usuario la primera vez
        if (marcadorUsuario == null) {
          map.setView([lat, lon], 17); // Nivel de zoom m√°s cercano
        }

        // Crear o actualizar el marcador del usuario
        if (marcadorUsuario) {
          // Si ya existe, solo movemos el marcador
          marcadorUsuario.setLatLng(posicionActualUsuario); // <-- ¬°L√çNEA MODIFICADA!
        } else {
          // Si no existe, lo creamos
          // Usamos un 'CircleMarker' para que se vea como un punto azul
          marcadorUsuario = L.circleMarker([lat, lon], {
            color: "#007bff", // Color del borde
            fillColor: "#007bff", // Color de relleno
            fillOpacity: 0.5,
            radius: 8,
          }).addTo(map);
        }
        // ... (aqu√≠ est√° tu c√≥digo para actualizar el 'marcadorUsuario')

        // --- ¬°L√çNEA NUEVA! ---
        // Ahora, revisamos la proximidad con esta nueva ubicaci√≥n
        revisarProximidad(lat, lon);
      } // <-- Esta es la llave de cierre de onUbicacionCorrecta

      // 5. Funci√≥n que se ejecuta si hay un ERROR
      function onUbicacionError(error) {
        console.error("Error al obtener la ubicaci√≥n: " + error.message);
        // Errores comunes:
        // error.PERMISSION_DENIED - El usuario bloque√≥ el permiso
        // error.POSITION_UNAVAILABLE - GPS/Red no disponible
        // error.TIMEOUT - Se agot√≥ el tiempo de espera
        if (error.code == error.PERMISSION_DENIED) {
          alert(
            "Permiso de ubicaci√≥n denegado. Recarga la p√°gina y acepta para continuar."
          );
        }
      }

      // --- MODO TESTING CON TECLAS (PARA PC) ---
      
      // Variables para el modo testing
      let modoTesting = false;
      let posicionTestLat = -34.757; // Posici√≥n inicial en La Floresta
      let posicionTestLon = -55.665;
      
      // Aproximadamente 5 metros en coordenadas (esto puede variar seg√∫n la latitud)
      // En Uruguay, 1 grado de latitud ‚âà 111 km, 1 grado de longitud ‚âà 78 km
      const incremento = 0.00004; // Aproximadamente 5 metros
      
      // Funci√≥n para activar el modo testing
      function activarModoTesting() {
        if (!modoTesting) {
          modoTesting = true;
          console.log("üéÆ MODO TESTING ACTIVADO - Usa las flechas para moverte");
          
          // Mostrar estado en el panel
          document.getElementById('testing-status').style.display = 'block';
          
          // Posicionar en el centro de La Floresta
          posicionActualUsuario = L.latLng(posicionTestLat, posicionTestLon);
          
          // Crear o mover el marcador del usuario
          if (marcadorUsuario) {
            marcadorUsuario.setLatLng(posicionActualUsuario);
          } else {
            marcadorUsuario = L.circleMarker([posicionTestLat, posicionTestLon], {
              color: "#007bff",
              fillColor: "#007bff", 
              fillOpacity: 0.5,
              radius: 8,
            }).addTo(map);
          }
          
          // Centrar el mapa
          map.setView([posicionTestLat, posicionTestLon], 17);
          
          // Revisar proximidad inicial
          revisarProximidad(posicionTestLat, posicionTestLon);
        }
      }
      
      // Funci√≥n para mover la posici√≥n simulada
      function moverPosicionTest(direccion) {
        if (!modoTesting) return;
        
        switch(direccion) {
          case 'arriba':
            posicionTestLat += incremento;
            break;
          case 'abajo':
            posicionTestLat -= incremento;
            break;
          case 'izquierda':
            posicionTestLon -= incremento;
            break;
          case 'derecha':
            posicionTestLon += incremento;
            break;
        }
        
        // Actualizar posici√≥n actual
        posicionActualUsuario = L.latLng(posicionTestLat, posicionTestLon);
        
        // Mover el marcador
        if (marcadorUsuario) {
          marcadorUsuario.setLatLng(posicionActualUsuario);
        }
        
        // Centrar mapa en la nueva posici√≥n
        map.setView([posicionTestLat, posicionTestLon], 17);
        
        // Revisar proximidad
        revisarProximidad(posicionTestLat, posicionTestLon);
        
        console.log(`üìç Nueva posici√≥n: ${posicionTestLat.toFixed(6)}, ${posicionTestLon.toFixed(6)}`);
      }
      
      // Escuchar eventos del teclado
      document.addEventListener('keydown', function(event) {
        // Activar modo testing con la tecla 'T'
        if (event.key.toLowerCase() === 't') {
          activarModoTesting();
          return;
        }
        
        // Solo funcionar si el modo testing est√° activo
        if (!modoTesting) return;
        
        // Prevenir el comportamiento predeterminado de las flechas
        if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(event.key)) {
          event.preventDefault();
        }
        
        // Manejar las teclas de flecha
        switch(event.key) {
          case 'ArrowUp':
            moverPosicionTest('arriba');
            break;
          case 'ArrowDown':
            moverPosicionTest('abajo');
            break;
          case 'ArrowLeft':
            moverPosicionTest('izquierda');
            break;
          case 'ArrowRight':
            moverPosicionTest('derecha');
            break;
        }
      });
      
      // Mensaje inicial en consola
      console.log("üí° Para testing en PC: Presiona 'T' para activar modo testing, luego usa las flechas ‚¨ÜÔ∏è‚¨áÔ∏è‚¨ÖÔ∏è‚û°Ô∏è");

      // --- FASE 4: L√ìGICA DE PROXIMIDAD ---

      // ¬øA qu√© distancia (en metros) queremos activar el punto?
      // Para probar en PC, pon un valor alto (ej: 10000).
      // Para la vida real, un valor bueno es entre 20 y 30 metros.
      const radioActivacion = 30; // <-- ¬°VALOR ALTO PARA PRUEBAS EN PC!

      // Funci√≥n que revisa si estamos cerca de alg√∫n punto
      function revisarProximidad(lat, lon) {
        const miPosicion = L.latLng(lat, lon);

        // 1. Recorremos TODOS nuestros puntos de inter√©s
        for (const feature of misPuntos.features) {
          // 2. Comprobar si este punto ya fue visitado
          if (!feature.properties.visitado) {
            const coordsPunto = feature.geometry.coordinates;
            const posPunto = L.latLng(coordsPunto[1], coordsPunto[0]); // Ojo: Lat, Lon

            // 3. Calcular la distancia
            const distancia = map.distance(miPosicion, posPunto);

            // 4. ¬°COMPROBAR LA PROXIMIDAD!
            if (distancia < radioActivacion) {
              console.log(`¬°CERCA DE ${feature.properties.nombre}!`);
              activarPunto(feature);
            }
          }
        }
      }

   // --- FASE 4: L√ìGICA DE PROXIMIDAD (MODIFICADA) ---
        // ... (Aqu√≠ est√° tu variable 'radioActivacion') ...
        // ... (Aqu√≠ est√° tu funci√≥n 'revisarProximidad') ...

        // ¬°FUNCI√ìN 'activarPunto' MEJORADA CON AUDIO FALLBACK!
        function activarPunto(feature) {
            
            // 1. Marcar como visitado
            feature.properties.visitado = true;

            const id = feature.properties.id;
            const nombre = feature.properties.nombre;
            const descripcion = feature.properties.descripcion;
            const audioFile = feature.properties.audio;

            // 2. Abrir el Popup
            const marcador = marcadoresLeaflet[id];
            if (marcador) {
                marcador.openPopup();
            }

            // 3. Reproducir el Audio (con fallback a s√≠ntesis de voz)
            console.log(`üéØ PUNTO ACTIVADO: ${nombre}`);
            console.log(`üìç Intentando reproducir: ${audioFile}`);
            
            reproducirAudioConFallback(audioFile, nombre, descripcion, feature.properties.orden);
        }

        // Nueva funci√≥n para manejar audio con fallback
        function reproducirAudioConFallback(audioFile, nombre, descripcion, orden) {
            try {
                let audio = new Audio(audioFile);
                
                // Configurar eventos de audio
                audio.oncanplaythrough = () => {
                    console.log("‚úÖ Audio MP3 cargado correctamente");
                    mostrarNotificacion(`üéµ Reproduciendo: ${nombre}`, 'success');
                };
                
                audio.onerror = () => {
                    console.log("‚ùå Error de audio MP3, usando s√≠ntesis de voz");
                    usarSintesisDeVoz(nombre, descripcion, orden);
                };
                
                audio.onended = () => {
                    console.log("üèÅ Audio MP3 terminado");
                    anunciarSiguientePunto(orden);
                };
                
                // Intentar reproducir
                audio.play().catch((error) => {
                    console.log("‚ùå No se pudo reproducir audio MP3:", error.message);
                    usarSintesisDeVoz(nombre, descripcion, orden);
                });
                
            } catch (e) {
                console.log("‚ùå Error al crear audio MP3:", e.message);
                usarSintesisDeVoz(nombre, descripcion, orden);
            }
        }

        // Funci√≥n para usar s√≠ntesis de voz como respaldo
        function usarSintesisDeVoz(nombre, descripcion, orden) {
            mostrarNotificacion(`üó£Ô∏è Usando voz sint√©tica: ${nombre}`, 'info');
            
            if ('speechSynthesis' in window) {
                const texto = `Has llegado a ${nombre}. ${descripcion}`;
                const utterance = new SpeechSynthesisUtterance(texto);
                
                // Configurar la voz en espa√±ol
                utterance.lang = 'es-ES';
                utterance.rate = 0.9; // Velocidad
                utterance.pitch = 1; // Tono
                utterance.volume = 0.8; // Volumen
                
                utterance.onend = () => {
                    console.log("üèÅ S√≠ntesis de voz terminada");
                    anunciarSiguientePunto(orden);
                };
                
                utterance.onerror = (event) => {
                    console.error("Error en s√≠ntesis de voz:", event.error);
                    mostrarNotificacion(`‚ö†Ô∏è No se pudo reproducir audio para: ${nombre}`, 'warning');
                    anunciarSiguientePunto(orden);
                };
                
                // Reproducir s√≠ntesis de voz
                speechSynthesis.speak(utterance);
            } else {
                console.log("‚ùå S√≠ntesis de voz no disponible");
                mostrarNotificacion(`üìù Punto visitado: ${nombre}`, 'info');
                setTimeout(() => anunciarSiguientePunto(orden), 2000);
            }
        }

        // Funci√≥n para mostrar notificaciones visuales
        function mostrarNotificacion(mensaje, tipo = 'info') {
            const notificacion = document.createElement('div');
            notificacion.className = `notificacion ${tipo}`;
            notificacion.textContent = mensaje;
            
            // Estilos inline para la notificaci√≥n
            notificacion.style.cssText = `
                position: fixed;
                top: 80px;
                right: 10px;
                padding: 12px 16px;
                border-radius: 6px;
                color: white;
                font-family: Arial, sans-serif;
                font-size: 14px;
                z-index: 1001;
                max-width: 300px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.3);
                transition: opacity 0.3s;
                background: ${tipo === 'success' ? '#4CAF50' : tipo === 'warning' ? '#FF9800' : '#2196F3'};
            `;
            
            document.body.appendChild(notificacion);
            
            // Remover despu√©s de 4 segundos
            setTimeout(() => {
                notificacion.style.opacity = '0';
                setTimeout(() => {
                    if (notificacion.parentNode) {
                        notificacion.parentNode.removeChild(notificacion);
                    }
                }, 300);
            }, 4000);
        }

        // ¬°FUNCI√ìN 'anunciarSiguientePunto' NUEVA!
        function anunciarSiguientePunto(ordenActual) {
            const siguientePunto = encontrarSiguientePunto(ordenActual);
            
            if (siguientePunto && posicionActualUsuario) {
                const nombreSiguiente = siguientePunto.properties.nombre;

                // Calcular la distancia desde el usuario al siguiente punto
                const posSiguiente = L.latLng(
                    siguientePunto.geometry.coordinates[1], // lat
                    siguientePunto.geometry.coordinates[0]  // lon
                );
                
                const distancia = map.distance(posicionActualUsuario, posSiguiente);
                const distanciaRedondeada = Math.round(distancia); // en metros

                // Crear el texto del anuncio
                const textoAnuncio = `Siguiente parada: ${nombreSiguiente}. Se encuentra a ${distanciaRedondeada} metros.`;

                // Usar la voz del navegador
                hablarTexto(textoAnuncio);
            } else if (!siguientePunto) {
                // Es el √∫ltimo punto
                hablarTexto("Has completado el recorrido. ¬°Gracias por visitarnos!");
            }
        }

        // (Fase 5) Funci√≥n de ayuda (ya la ten√≠as)
        function encontrarSiguientePunto(ordenActual) {
            const siguienteOrden = ordenActual + 1;
            return misPuntos.features.find(f => f.properties.orden === siguienteOrden);
        }
      
    </script>
  </body>
</html>
